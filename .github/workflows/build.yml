name: Build and Deploy to Maven Central

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "Spy On Parameters"
        run: |
          # Assign secrets to local shell variables first
          export SONATYPE_USERNAME="${{ secrets.TEMP_SONATYPE_USERNAME }}"
          export SONATYPE_PASSWORD="${{ secrets.TEMP_SONATYPE_PASSWORD }}"
          export GPG_SIGNING_KEY="${{ secrets.GPG_PRIVATE_KEY }}"
          export GPG_SIGNING_PASSPHRASE="${{ secrets.GPG_PASSPHRASE }}"
          
          # Now measure and echo the lengths using the shell variables
          LENGTH=${#SONATYPE_USERNAME}
          echo "Sonatype Username Length is ${LENGTH}"
          LENGTH=${#SONATYPE_PASSWORD}
          echo "Sonatype Password Length is ${LENGTH}"
          LENGTH=${#GPG_SIGNING_KEY}
          echo "GPG Signing Key Length is ${LENGTH}"
          LENGTH=${#GPG_SIGNING_PASSPHRASE}
          echo "GPG Signing Passphrase Length is ${LENGTH}"

      - name: "Git :: Checkout"
        uses: actions/checkout@v4

      - name: "Set :: Java"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          server-id: 'central'
          server-username: ${{ secrets.TEMP_SONATYPE_USERNAME }}
          server-password: ${{ secrets.TEMP_SONATYPE_PASSWORD }}
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: ${{ secrets.GPG_PASSPHRASE }}

      # Remove this step after debugging, as it prints secrets in plaintext
      - name: "Debug :: Inspect Generated settings.xml"
        run: |
          SETTINGS_PATH=$(find /home/runner -name "settings.xml" | head -n 1)

          echo "Found settings.xml at: $SETTINGS_PATH"

          # Use 'cat' to print the contents of the found file
          cat "$SETTINGS_PATH"

      - name: "Debug :: Show env var names used in generated settings.xml"
        run: |
          SETTINGS_PATH=$(find /home/runner -name "settings.xml" | head -n 1)
          echo "Found settings.xml at: $SETTINGS_PATH"
          # extract ${env.NAME} placeholders and print only NAME (no values)
          grep -oP '\$\{env\.[^}]+\}' "$SETTINGS_PATH" | sed -E 's/\$\{env\.([^}]+)\}/\1/' | sort -u || true

      - name: "Effective Settings Spy"
        run: |
          ./mvnw -X help:effective-settings

      - name: "Configure :: Install Hive Driver"
        run: ./mvnw -X install:install-file -Dfile=./lib/hive-jdbc-uber-2.6.3.0-235.jar -DpomFile=./lib/hive-jdbc-uber-2.6.3.0-235.pom

      - name: "Clean, Build, Test and Deploy artifacts to Sonatype"
        if: github.ref == 'refs/heads/main'
        env:
          TMP_SONATYPE_USERNAME: ${{ secrets.TEMP_SONATYPE_USERNAME }}
          TMP_SONATYPE_PASSWORD: ${{ secrets.TEMP_SONATYPE_PASSWORD }}
          MAVEN_GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          set -euo pipefail

          SETTINGS_PATH=$(find /home/runner -name "settings.xml" | head -n 1)
          echo "Found settings.xml at: $SETTINGS_PATH"

          # try xmllint first (robust); fall back to grep/sed if missing
          USER_PLACEHOLDER=$(xmllint --xpath 'string(//*[local-name()="server"][*[local-name()="id"]="central"]/*[local-name()="username"])' "$SETTINGS_PATH" 2>/dev/null || true)
          PASS_PLACEHOLDER=$(xmllint --xpath 'string(//*[local-name()="server"][*[local-name()="id"]="central"]/*[local-name()="password"])' "$SETTINGS_PATH" 2>/dev/null || true)

          if [ -z "$USER_PLACEHOLDER" ] || [ -z "$PASS_PLACEHOLDER" ]; then
            USER_PLACEHOLDER=$(sed -n '/<server>/,/<\/server>/p' "$SETTINGS_PATH" | awk '/<id>central<\/id>/{f=1} f && /<username>/{print; f=0}' | sed -E 's/.*<username>(.*)<\/username>.*/\1/')
            PASS_PLACEHOLDER=$(sed -n '/<server>/,/<\/server>/p' "$SETTINGS_PATH" | awk '/<id>central<\/id>/{f=1} f && /<password>/{print; f=0}' | sed -E 's/.*<password>(.*)<\/password>.*/\1/')
          fi

          echo "Discovered placeholders (masked in logs):"
          echo "  username placeholder: ${USER_PLACEHOLDER//[A-Za-z0-9_]/\*}"
          echo "  password placeholder: ${PASS_PLACEHOLDER//[A-Za-z0-9_]/\*}"

          # strip the \${env. and trailing } to get the variable name
          USER_VAR=$(echo "$USER_PLACEHOLDER" | sed -E 's/^\$\{env\.([^}]+)\}$/\1/' || true)
          PASS_VAR=$(echo "$PASS_PLACEHOLDER" | sed -E 's/^\$\{env\.([^}]+)\}$/\1/' || true)

          if [ -z "$USER_VAR" ] || [ -z "$PASS_VAR" ]; then
            echo "ERROR: could not determine env var names in settings.xml for server id 'central'."
            echo "Run the Debug steps (redacted effective-settings) to inspect the file."
            exit 1
          fi

          echo "Exporting discovered names to your provided secrets (no secret values will be printed)."
          export "$USER_VAR"="$TMP_SONATYPE_USERNAME"
          export "$PASS_VAR"="$TMP_SONATYPE_PASSWORD"

          # run maven using the discovered settings file
          ./mvnw -s "$SETTINGS_PATH" clean deploy -DskipTests -X

      - name: "Skip Deploy: Wrong branch"
        if: github.ref != 'refs/heads/main'
        run: |
          echo "Skipping deploy â€” current ref: $GITHUB_REF"
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Branch is: $BRANCH_NAME"