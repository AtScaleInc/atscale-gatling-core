name: Build and Deploy to Maven Central

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "Spy On Parameters"
        run: |
          # Assign secrets to local shell variables first
          export SONATYPE_USERNAME="${{ secrets.TEMP_SONATYPE_USERNAME }}"
          export SONATYPE_PASSWORD="${{ secrets.TEMP_SONATYPE_PASSWORD }}"
          export GPG_SIGNING_KEY="${{ secrets.GPG_PRIVATE_KEY }}"
          export GPG_SIGNING_PASSPHRASE="${{ secrets.GPG_PASSPHRASE }}"
          
          # Now measure and echo the lengths using the shell variables
          LENGTH=${#SONATYPE_USERNAME}
          echo "Sonatype Username Length is ${LENGTH}"
          LENGTH=${#SONATYPE_PASSWORD}
          echo "Sonatype Password Length is ${LENGTH}"
          LENGTH=${#GPG_SIGNING_KEY}
          echo "GPG Signing Key Length is ${LENGTH}"
          LENGTH=${#GPG_SIGNING_PASSPHRASE}
          echo "GPG Signing Passphrase Length is ${LENGTH}"

      - name: "Git :: Checkout"
        uses: actions/checkout@v4

      - name: "Set :: Java"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          server-id: 'central'
          #server-username: ${{ secrets.TEMP_SONATYPE_USERNAME }}
          #server-password: ${{ secrets.TEMP_SONATYPE_PASSWORD }}
          #gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          #gpg-passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: "Maven :: Clean"
        run: |
          ./mvnw -X clean

      - name: "Configure :: Install Hive Driver"
        run: ./mvnw -X install:install-file -Dfile=./lib/hive-jdbc-uber-2.6.3.0-235.jar -DpomFile=./lib/hive-jdbc-uber-2.6.3.0-235.pom

      - name: "Prepare deterministic settings.xml"
        run: |
          mkdir -p "$GITHUB_WORKSPACE/.m2"
          cat > "$GITHUB_WORKSPACE/.m2/settings.xml" <<'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>central</id>
                <username>${env.SONATYPE_USERNAME}</username>
                <password>${env.SONATYPE_PASSWORD}</password>
              </server>
              <server>
                <id>gpg.passphrase</id>
                <passphrase>${env.MAVEN_GPG_PASSPHRASE}</passphrase>
              </server>
            </servers>
          </settings>
          EOF
          echo "Wrote settings to $GITHUB_WORKSPACE/.m2/settings.xml"

      - name: "Build, Test and Deploy artifacts to Sonatype"
        if: github.ref == 'refs/heads/main'
        env:
          SONATYPE_USERNAME: ${{ secrets.TEMP_SONATYPE_USERNAME }}
          SONATYPE_PASSWORD: ${{ secrets.TEMP_SONATYPE_PASSWORD }}
          MAVEN_GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          ./mvnw -s "$GITHUB_WORKSPACE/.m2/settings.xml" deploy -DskipTests -X
          

      - name: "Skip Deploy: Wrong branch"
        if: github.ref != 'refs/heads/main'
        run: |
          echo "Skipping deploy â€” current ref: $GITHUB_REF"
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Branch is: $BRANCH_NAME"