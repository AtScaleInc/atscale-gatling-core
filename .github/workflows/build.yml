name: Build and Deploy to Maven Central

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "Spy On Parameters"
        run: |
          # Assign secrets to local shell variables first
          export SONATYPE_USERNAME="${{ secrets.TEMP_SONATYPE_USERNAME }}"
          export SONATYPE_PASSWORD="${{ secrets.TEMP_SONATYPE_PASSWORD }}"
          export GPG_SIGNING_KEY="${{ secrets.GPG_PRIVATE_KEY }}"
          export GPG_SIGNING_PASSPHRASE="${{ secrets.GPG_PASSPHRASE }}"
          
          # Now measure and echo the lengths using the shell variables
          LENGTH=${#SONATYPE_USERNAME}
          echo "Sonatype Username Length is ${LENGTH}"
          LENGTH=${#SONATYPE_PASSWORD}
          echo "Sonatype Password Length is ${LENGTH}"
          LENGTH=${#GPG_SIGNING_KEY}
          echo "GPG Signing Key Length is ${LENGTH}"
          LENGTH=${#GPG_SIGNING_PASSPHRASE}
          echo "GPG Signing Passphrase Length is ${LENGTH}"

      - name: "Git :: Checkout"
        uses: actions/checkout@v4

      - name: "Set :: Java"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          server-id: 'central'
          server-username: ${{ secrets.TEMP_SONATYPE_USERNAME }}
          server-password: ${{ secrets.TEMP_SONATYPE_PASSWORD }}
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: ${{ secrets.GPG_PASSPHRASE }}

      # Remove this step after debugging, as it prints secrets in plaintext
      - name: "Debug :: Inspect Generated settings.xml"
        run: |
          SETTINGS_PATH=$(find /home/runner -name "settings.xml" | head -n 1)

          echo "Found settings.xml at: $SETTINGS_PATH"

          # Use 'cat' to print the contents of the found file
          cat "$SETTINGS_PATH"

      - name: "Debug :: Show env var names used in generated settings.xml"
        run: |
          SETTINGS_PATH=$(find /home/runner -name "settings.xml" | head -n 1)
          echo "Found settings.xml at: $SETTINGS_PATH"
          # extract ${env.NAME} placeholders and print only NAME (no values)
          grep -oP '\$\{env\.[^}]+\}' "$SETTINGS_PATH" | sed -E 's/\$\{env\.([^}]+)\}/\1/' | sort -u || true

      - name: "Configure :: Install Hive Driver"
        run: ./mvnw -X install:install-file -Dfile=./lib/hive-jdbc-uber-2.6.3.0-235.jar -DpomFile=./lib/hive-jdbc-uber-2.6.3.0-235.pom

      - name: "Clean, Build, Test and Deploy artifacts to Sonatype"
        if: github.ref == 'refs/heads/main'
        run: |
          SETTINGS_PATH=$(find /home/runner -name "settings.xml" | head -n 1)
          echo "Found settings.xml at: $SETTINGS_PATH"
          ./mvnw -s "$SETTINGS_PATH" clean deploy -DskipTests -X
        env:
          MAVEN_GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: "Skip Deploy: Wrong branch"
        if: github.ref != 'refs/heads/main'
        run: |
          echo "Skipping deploy â€” current ref: $GITHUB_REF"
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Branch is: $BRANCH_NAME"